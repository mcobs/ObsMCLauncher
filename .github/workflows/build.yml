name: Build ObsMCLauncher

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    # å¦‚æœæäº¤ä¿¡æ¯åŒ…å« [CI skip] æˆ– [ci skip]ï¼Œè·³è¿‡æ„å»º
    if: "!contains(github.event.head_commit.message, '[CI skip]') && !contains(github.event.head_commit.message, '[ci skip]')"
    
    strategy:
      matrix:
        configuration: [Release]
    
    runs-on: windows-latest  # åœ¨ Windows ç¯å¢ƒæ„å»º WPF åº”ç”¨
    
    env:
      Solution_Name: ObsMCLauncher.csproj
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„ git å†å²
      
    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    # æ·»åŠ  MSBuild åˆ° PATH
    - name: Setup MSBuild.exe
      uses: microsoft/setup-msbuild@v2
        
    - name: Restore dependencies
      run: dotnet restore $env:Solution_Name
      
    - name: Build application
      run: dotnet build $env:Solution_Name -c ${{ matrix.configuration }} --no-restore
      
    - name: Publish single-file executable
      run: dotnet publish $env:Solution_Name -c ${{ matrix.configuration }} -r win-x64 --self-contained false -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=false -o ./publish
      
    - name: Get version info
      id: version
      shell: pwsh
      run: |
        $date = Get-Date -Format "yyyyMMdd"
        $shortSha = "${{ github.sha }}".Substring(0, 7)
        $version = "v1.0.0-$date-$shortSha"
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "å½“å‰ç‰ˆæœ¬: $version"
        
    - name: Verify and rename executable
      shell: pwsh
      run: |
        $exePath = "./publish/ObsMCLauncher.exe"
        if (-not (Test-Path $exePath)) {
          Write-Error "å‘å¸ƒæ–‡ä»¶ä¸å­˜åœ¨: $exePath"
          exit 1
        }
        
        $version = "${{ steps.version.outputs.version }}"
        $exeName = "ObsMCLauncher-$version-win-x64.exe"
        Copy-Item -Path $exePath -Destination $exeName
        
        $fileInfo = Get-Item $exeName
        $fileSizeMB = [Math]::Round($fileInfo.Length / 1MB, 2)
        
        Write-Host "âœ… å·²é‡å‘½åä¸º: $exeName"
        Write-Host "ğŸ“¦ æ–‡ä»¶å¤§å°: $fileSizeMB MB"
        
        # éªŒè¯æ–‡ä»¶å¤§å°åˆç†æ€§ï¼ˆæ¡†æ¶ä¾èµ–å‘å¸ƒåº”è¯¥åœ¨5-20MBä¹‹é—´ï¼‰
        if ($fileSizeMB -gt 50) {
          Write-Warning "âš ï¸ æ–‡ä»¶å¤§å°å¼‚å¸¸å¤§ ($fileSizeMB MB)ï¼Œå¯èƒ½é…ç½®æœ‰è¯¯"
        }
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ObsMCLauncher-${{ steps.version.outputs.version }}-win-x64
        path: ObsMCLauncher-${{ steps.version.outputs.version }}-win-x64.exe
        retention-days: 90
        compression-level: 6
        if-no-files-found: error

