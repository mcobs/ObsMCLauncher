name: Release ObsMCLauncher

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        rid: [win-x86, win-x64, win-arm64]
    
    env:
      Project_Path: ObsMCLauncher.Desktop/ObsMCLauncher.Desktop.csproj
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore $env:Project_Path
      
    - name: Build application
      run: dotnet build $env:Project_Path -c Release --no-restore

    - name: Get version info
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.tag }}"
        } else {
          $version = "${{ github.ref_name }}"
        }
        $versionNumber = $version -replace '^v', ''
        $isPrerelease = $version -match '-(alpha|beta|rc|pre|test|preview)'
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "version_number=$versionNumber" >> $env:GITHUB_OUTPUT
        echo "is_prerelease=$isPrerelease" >> $env:GITHUB_OUTPUT
        echo "å½“å‰ç‰ˆæœ¬: $version"
        echo "æ˜¯å¦é¢„å‘å¸ƒ: $isPrerelease"

    - name: Publish ${{ matrix.rid }}
      run: |
        dotnet publish $env:Project_Path -c Release -r ${{ matrix.rid }} --self-contained false `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:DebugType=none `
          -p:DebugSymbols=false `
          -p:Version=${{ steps.version.outputs.version_number }} `
          -o ./publish/${{ matrix.rid }}

    - name: Create ZIP archive
      shell: pwsh
      run: |
        Compress-Archive -Path ./publish/${{ matrix.rid }}/* -DestinationPath ./ObsMCLauncher-${{ steps.version.outputs.version }}-${{ matrix.rid }}.zip
        $zipFile = Get-Item ./ObsMCLauncher-${{ steps.version.outputs.version }}-${{ matrix.rid }}.zip
        $fileSizeMB = [Math]::Round($zipFile.Length / 1MB, 2)
        Write-Host "åˆ›å»º ZIP æ–‡ä»¶: $($zipFile.Name), å¤§å°: $fileSizeMB MB"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ObsMCLauncher-${{ steps.version.outputs.version }}-${{ matrix.rid }}
        path: ./ObsMCLauncher-${{ steps.version.outputs.version }}-${{ matrix.rid }}.zip
        retention-days: 1

  release:
    needs: build
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version info
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.tag }}"
        } else {
          $version = "${{ github.ref_name }}"
        }
        $isPrerelease = $version -match '-(alpha|beta|rc|pre|test|preview)'
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "is_prerelease=$isPrerelease" >> $env:GITHUB_OUTPUT
        echo "å½“å‰ç‰ˆæœ¬: $version"
        echo "æ˜¯å¦é¢„å‘å¸ƒ: $isPrerelease"

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: List artifacts
      shell: pwsh
      run: |
        Write-Host "Artifacts ç›®å½•å†…å®¹:"
        Get-ChildItem ./artifacts -Recurse | Format-Table FullName, Length

    - name: Prepare release files
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        New-Item -ItemType Directory -Force -Path ./release
        
        $zipFiles = Get-ChildItem ./artifacts -Recurse -Filter "*.zip"
        Write-Host "æ‰¾åˆ° $($zipFiles.Count) ä¸ª ZIP æ–‡ä»¶"
        
        if ($zipFiles.Count -eq 0) {
          Write-Error "é”™è¯¯: æ²¡æœ‰æ‰¾åˆ° ZIP æ–‡ä»¶ï¼"
          exit 1
        }
        
        $zipFiles | ForEach-Object {
          Write-Host "å¤åˆ¶æ–‡ä»¶: $($_.FullName) -> ./release/"
          Copy-Item $_.FullName ./release/
        }
        
        Write-Host "Release ç›®å½•å†…å®¹:"
        Get-ChildItem ./release | Format-Table Name, Length

    - name: Create Release
      uses: actions/github-script@v6
      with:
        script: |
          const version = '${{ steps.version.outputs.version }}';
          const isPrerelease = ${{ steps.version.outputs.is_prerelease == 'true' }};
          
          // å‡†å¤‡å‘å¸ƒä½“
          let body = `## ğŸ“¥ ä¸‹è½½\n\n`;
          body += `| å¹³å° | æ¶æ„ | æ–‡ä»¶ |\n`;
          body += `|:----:|:----:|:----:|\n`;
          body += `| Windows | x86 (32ä½) | [ObsMCLauncher-${version}-win-x86.zip](https://github.com/${{ github.repository }}/releases/download/${version}/ObsMCLauncher-${version}-win-x86.zip) |\n`;
          body += `| Windows | x64 (64ä½) | [ObsMCLauncher-${version}-win-x64.zip](https://github.com/${{ github.repository }}/releases/download/${version}/ObsMCLauncher-${version}-win-x64.zip) |\n`;
          body += `| Windows | ARM64 | [ObsMCLauncher-${version}-win-arm64.zip](https://github.com/${{ github.repository }}/releases/download/${version}/ObsMCLauncher-${version}-win-arm64.zip) |\n\n`;
          
          if (isPrerelease) {
            body += `---\n\n## âš ï¸ é¢„å‘å¸ƒç‰ˆæœ¬è­¦å‘Š\n\n`;
            body += `**æ­¤ç‰ˆæœ¬ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š**\n`;
            body += `- ğŸ› å¯èƒ½åŒ…å«æœªå‘ç°çš„ Bug\n`;
            body += `- âš¡ åŠŸèƒ½å¯èƒ½ä¸ç¨³å®š\n`;
            body += `- ğŸ”„ éƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¼šåœ¨æ­£å¼ç‰ˆä¸­æ›´æ”¹\n\n`;
            body += `**ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒæˆ–æ—¥å¸¸ä½¿ç”¨ä¸­ä½¿ç”¨æ­¤ç‰ˆæœ¬ã€‚**\n\n`;
            body += `å¦‚æœæ‚¨å‘ç°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚\n`;
          } else {
            body += `---\n`;
          }
          
          body += `\n## ğŸ“‹ æ›´æ–°å†…å®¹\n`;
          
          // åˆ›å»ºå‘å¸ƒ
          const release = await github.rest.repos.createRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            tag_name: version,
            name: `ObsMCLauncher ${version}`,
            body: body,
            draft: false,
            prerelease: isPrerelease
          });
          
          console.log('åˆ›å»ºå‘å¸ƒæˆåŠŸ:', release.data.html_url);
          
          // ä¸Šä¼ æ–‡ä»¶
          const fs = require('fs');
          const path = require('path');
          const releaseFiles = fs.readdirSync('./release');
          
          for (const file of releaseFiles) {
            if (file.endsWith('.zip')) {
              const filePath = path.join('./release', file);
              console.log(`ä¸Šä¼ æ–‡ä»¶: ${file}`);
              
              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id,
                name: file,
                data: fs.readFileSync(filePath)
              });
              
              console.log(`æ–‡ä»¶ ${file} ä¸Šä¼ æˆåŠŸ`);
            }
          }
          
          console.log('æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ');
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
