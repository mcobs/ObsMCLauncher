name: Release ObsMCLauncher

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        rid: [win-x86, win-x64, win-arm64]
    
    env:
      Project_Path: ObsMCLauncher.Desktop/ObsMCLauncher.Desktop.csproj
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore dependencies
      run: dotnet restore $env:Project_Path
      
    - name: Build application
      run: dotnet build $env:Project_Path -c Release --no-restore

    - name: Get version info
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.tag }}"
        } else {
          $version = "${{ github.ref_name }}"
        }
        $versionNumber = $version -replace '^v', ''
        $isPrerelease = $version -match '-(alpha|beta|rc|pre|test|preview)'
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "version_number=$versionNumber" >> $env:GITHUB_OUTPUT
        echo "is_prerelease=$isPrerelease" >> $env:GITHUB_OUTPUT
        echo "å½“å‰ç‰ˆæœ¬: $version"
        echo "æ˜¯å¦é¢„å‘å¸ƒ: $isPrerelease"

    - name: Publish ${{ matrix.rid }}
      run: |
        dotnet publish $env:Project_Path -c Release -r ${{ matrix.rid }} --self-contained false `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:DebugType=none `
          -p:DebugSymbols=false `
          -p:Version=${{ steps.version.outputs.version_number }} `
          -o ./publish/${{ matrix.rid }}

    - name: Create ZIP archive
      shell: pwsh
      run: |
        Compress-Archive -Path ./publish/${{ matrix.rid }}/* -DestinationPath ./ObsMCLauncher-${{ steps.version.outputs.version }}-${{ matrix.rid }}.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ObsMCLauncher-${{ steps.version.outputs.version }}-${{ matrix.rid }}
        path: ./ObsMCLauncher-${{ steps.version.outputs.version }}-${{ matrix.rid }}.zip
        retention-days: 1

  release:
    needs: build
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version info
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.tag }}"
        } else {
          $version = "${{ github.ref_name }}"
        }
        $isPrerelease = $version -match '-(alpha|beta|rc|pre|test|preview)'
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "is_prerelease=$isPrerelease" >> $env:GITHUB_OUTPUT
        echo "å½“å‰ç‰ˆæœ¬: $version"
        echo "æ˜¯å¦é¢„å‘å¸ƒ: $isPrerelease"

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Prepare release files
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        New-Item -ItemType Directory -Force -Path ./release
        Get-ChildItem ./artifacts -Recurse -Filter "*.zip" | ForEach-Object {
          Copy-Item $_.FullName ./release/
        }
        Write-Host "Release files:"
        Get-ChildItem ./release | Format-Table Name, Length

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: ObsMCLauncher ${{ steps.version.outputs.version }}
        draft: false
        prerelease: ${{ steps.version.outputs.is_prerelease == 'true' }}
        generate_release_notes: true
        body: |
          ## ğŸ“¥ ä¸‹è½½
          
          | å¹³å° | æ¶æ„ | æ–‡ä»¶ |
          |:----:|:----:|:----:|
          | Windows | x86 (32ä½) | [ObsMCLauncher-${{ steps.version.outputs.version }}-win-x86.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/ObsMCLauncher-${{ steps.version.outputs.version }}-win-x86.zip) |
          | Windows | x64 (64ä½) | [ObsMCLauncher-${{ steps.version.outputs.version }}-win-x64.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/ObsMCLauncher-${{ steps.version.outputs.version }}-win-x64.zip) |
          | Windows | ARM64 | [ObsMCLauncher-${{ steps.version.outputs.version }}-win-arm64.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/ObsMCLauncher-${{ steps.version.outputs.version }}-win-arm64.zip) |
          
          ${{ steps.version.outputs.is_prerelease == 'true' && '---\n\n## âš ï¸ é¢„å‘å¸ƒç‰ˆæœ¬è­¦å‘Š\n\n**æ­¤ç‰ˆæœ¬ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š**\n- ğŸ› å¯èƒ½åŒ…å«æœªå‘ç°çš„ Bug\n- âš¡ åŠŸèƒ½å¯èƒ½ä¸ç¨³å®š\n- ğŸ”„ éƒ¨åˆ†åŠŸèƒ½å¯èƒ½ä¼šåœ¨æ­£å¼ç‰ˆä¸­æ›´æ”¹\n\n**ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒæˆ–æ—¥å¸¸ä½¿ç”¨ä¸­ä½¿ç”¨æ­¤ç‰ˆæœ¬ã€‚**\n\nå¦‚æœæ‚¨å‘ç°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚\n' || '---' }}
          
          ## ğŸ“‹ æ›´æ–°å†…å®¹
        files: ./release/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
