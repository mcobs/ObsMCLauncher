<Page x:Class="ObsMCLauncher.Pages.SettingsPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="900"
      KeepAlive="True"
      Background="{DynamicResource BackgroundBrush}"
      UseLayoutRounding="True"
      TextOptions.TextFormattingMode="Display"
      TextOptions.TextRenderingMode="ClearType">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 悬浮保存通知卡片 -->
        <Border x:Name="SaveNotification"
                Grid.Row="1"
                Width="320"
                HorizontalAlignment="Center"
                VerticalAlignment="Top"
                Margin="0,20,0,0"
                Background="{DynamicResource SurfaceBrush}"
                CornerRadius="10"
                Opacity="0"
                Panel.ZIndex="1000">
            <Border.Effect>
                <DropShadowEffect Color="Black" 
                                BlurRadius="20" 
                                ShadowDepth="2" 
                                Opacity="0.3"/>
            </Border.Effect>
            
            <StackPanel Margin="20,15">
                <!-- 图标和文字 -->
                <Grid Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <Border Grid.Column="0"
                            Background="{StaticResource PrimaryBrush}"
                            CornerRadius="20"
                            Width="36"
                            Height="36"
                            Margin="0,0,12,0">
                        <materialDesign:PackIcon Kind="CheckCircle"
                                               Width="20"
                                               Height="20"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"/>
                    </Border>
                    
                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <TextBlock x:Name="SaveNotificationText"
                                 Text="设置已自动保存"
                                 FontSize="14"
                                 FontWeight="SemiBold"
                                 Margin="0,0,0,2"/>
                        <TextBlock Text="修改已生效"
                                 FontSize="11"
                                 Foreground="{DynamicResource TextSecondaryBrush}"/>
                    </StackPanel>
                </Grid>
                
                <!-- 进度条 -->
                <ProgressBar x:Name="SaveProgressBar"
                             Height="3"
                             Minimum="0"
                             Maximum="100"
                             Value="0"
                             Foreground="{DynamicResource PrimaryBrush}"
                             Background="{DynamicResource BorderBrush}"
                             BorderThickness="0"/>
            </StackPanel>
        </Border>

        <!-- 主要内容区域 -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
        <Grid Margin="30">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- 标题区域 -->
            <StackPanel Grid.Row="0">
                <TextBlock Text="设置" 
                         FontSize="28" 
                         FontWeight="Bold"
                         Margin="0,0,0,10"/>
                    <TextBlock Text="配置启动器和游戏参数（修改后自动保存）" 
                         FontSize="14" 
                         Foreground="{DynamicResource TextSecondaryBrush}"
                         Margin="0,0,0,25"/>
            </StackPanel>

            <!-- 设置内容 -->
            <StackPanel Grid.Row="1">
                
                <!-- 游戏设置 -->
                <Border Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="游戏设置" 
                                 FontSize="20" 
                                 FontWeight="SemiBold"
                                 Margin="0,0,0,15"/>

                        <!-- 游戏目录 -->
                        <TextBlock Text="游戏目录" 
                                 FontSize="14" 
                                 Margin="0,0,0,6"/>
                        <ComboBox x:Name="GameDirectoryLocationComboBox"
                                Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                SelectionChanged="GameDirectoryLocation_Changed_AutoSave"
                                Margin="0,0,0,8">
                            <ComboBoxItem Content="%APPDATA%\.minecraft（默认）" Tag="AppData"/>
                            <ComboBoxItem Content="运行目录\.minecraft" Tag="RunningDirectory"/>
                            <ComboBoxItem Content="自定义" Tag="Custom"/>
                        </ComboBox>
                        <Grid x:Name="CustomGameDirectoryPanel" Margin="0,0,0,12" Visibility="Collapsed">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="GameDirectoryTextBox"
                                   Grid.Column="0"
                                   materialDesign:HintAssist.Hint="自定义游戏目录"
                                   Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                   Foreground="{DynamicResource TextBrush}"
                                   CaretBrush="#FFFFFF"
                                   Margin="0,0,10,0"
                                   LostFocus="GameDirectoryTextBox_LostFocus"
                                   TextChanged="GameDirectoryTextBox_TextChanged"/>
                            <Button Grid.Column="1"
                                  Content="浏览"
                                  Style="{StaticResource MaterialDesignOutlinedButton}"
                                  Width="100"
                                  Click="BrowseGameDirectory_Click"/>
                        </Grid>
                        <TextBlock x:Name="GameDirectoryDisplayText"
                                 FontSize="12"
                                 Foreground="{DynamicResource TextSecondaryBrush}"
                                 TextWrapping="Wrap"
                                 Margin="0,0,0,12"/>

                        <!-- 内存分配 -->
                        <TextBlock Text="最大内存分配 (最小内存固定为512MB)" 
                                 FontSize="14" 
                                 Margin="0,0,0,6"/>
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="100"/>
                            </Grid.ColumnDefinitions>
                            <Slider x:Name="MaxMemorySlider"
                                  Grid.Column="0"
                                  Minimum="1024"
                                  Maximum="65536"
                                  Value="4096"
                                  TickFrequency="1"
                                  IsSnapToTickEnabled="True"
                                  Style="{StaticResource MaterialDesignDiscreteSlider}"
                                  Margin="0,0,20,0"
                                  ValueChanged="MaxMemorySlider_ValueChanged"/>
                            <TextBox x:Name="MaxMemoryTextBox"
                                     Grid.Column="1"
                                   Text="4096"
                                   Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                   Foreground="{DynamicResource TextBrush}"
                                   CaretBrush="#FFFFFF"
                                     FontSize="14"
                                     VerticalAlignment="Center"
                                   TextAlignment="Right"
                                   materialDesign:HintAssist.Hint="MB"
                                   PreviewTextInput="MaxMemoryTextBox_PreviewTextInput"
                                   TextChanged="MaxMemoryTextBox_TextChanged"/>
                        </Grid>

                        <!-- 版本隔离 -->
                        <TextBlock Text="版本隔离" 
                                 FontSize="14" 
                                 Margin="0,0,0,6"/>
                        <ComboBox x:Name="GameDirectoryTypeComboBox"
                                Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                SelectionChanged="GameDirectoryType_Changed_AutoSave"
                                Margin="0,0,0,8">
                            <ComboBoxItem Content="关闭 - 所有版本共享mods文件夹" Tag="RootFolder"/>
                            <ComboBoxItem Content="开启 - 每个版本使用独立mods文件夹" Tag="VersionFolder"/>
                        </ComboBox>
                        <TextBlock Text="开启后，每个版本将使用独立的mods、saves、resourcepacks等文件夹"
                                 FontSize="12"
                                 Foreground="{DynamicResource TextSecondaryBrush}"
                                 TextWrapping="Wrap"
                                 Margin="0,0,0,12"/>

                        <!-- Java 选择 -->
                        <TextBlock Text="Java 路径" 
                                 FontSize="14" 
                                 Margin="0,0,0,6"/>
                        <ComboBox x:Name="JavaPathComboBox"
                                Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                SelectionChanged="JavaPathComboBox_SelectionChanged"
                                Margin="0,0,0,8">
                        </ComboBox>
                        
                        <!-- 自定义Java路径面板 -->
                        <Grid x:Name="CustomJavaPanel" Margin="0,0,0,12" Visibility="Collapsed">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="CustomJavaTextBox"
                                   Grid.Column="0"
                                   materialDesign:HintAssist.Hint="自定义Java路径"
                                   Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                   Foreground="{DynamicResource TextBrush}"
                                   CaretBrush="#FFFFFF"
                                   Margin="0,0,10,0"
                                   LostFocus="CustomJavaTextBox_LostFocus"
                                   TextChanged="CustomJavaTextBox_TextChanged"/>
                            <Button Grid.Column="1"
                                  Content="浏览"
                                  Style="{StaticResource MaterialDesignOutlinedButton}"
                                  Width="100"
                                  Click="BrowseCustomJavaPath_Click"/>
                        </Grid>

                        <!-- 高级设置 - JVM 参数 -->
                        <Expander Header="高级设置"
                                  Foreground="{DynamicResource TextBrush}"
                                  Margin="0,0,0,0">
                            <StackPanel Margin="0,10,0,0">
                                <TextBlock Text="JVM 参数" 
                                         FontSize="14" 
                                         Margin="0,0,0,6"/>
                                <TextBox x:Name="JvmArgumentsTextBox"
                                       Text="-XX:+UseG1GC -XX:+UnlockExperimentalVMOptions"
                                       Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                       Foreground="{DynamicResource TextBrush}"
                                       CaretBrush="#FFFFFF"
                                       AcceptsReturn="True"
                                       TextWrapping="Wrap"
                                       MinHeight="60"
                                       VerticalScrollBarVisibility="Auto"
                                       LostFocus="JvmArgumentsTextBox_LostFocus"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </Border>

                <!-- 启动器设置 -->
                <Border Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="启动器设置" 
                                 FontSize="20" 
                                 FontWeight="SemiBold"
                                 Margin="0,0,0,15"/>

                        <!-- 主题设置 -->
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="主题模式" 
                                         FontSize="14" 
                                         Margin="0,0,0,4"/>
                                <TextBlock Text="选择启动器的外观主题" 
                                         FontSize="12" 
                                         Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>
                            <ComboBox x:Name="ThemeModeComboBox"
                                    Grid.Column="1"
                                    Width="150"
                                    Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                    VerticalAlignment="Center"
                                    SelectionChanged="ThemeModeComboBox_SelectionChanged">
                                <ComboBoxItem Content="深色模式" IsSelected="True"/>
                                <ComboBoxItem Content="浅色模式"/>
                                <ComboBoxItem Content="跟随系统"/>
                            </ComboBox>
                        </Grid>

                        <Separator Margin="0,8,0,12" Background="{DynamicResource BorderBrush}"/>

                        <!-- 自动检查更新 -->
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="自动检查更新" 
                                         FontSize="14" 
                                         Margin="0,0,0,4"/>
                                <TextBlock Text="启动时检查启动器更新" 
                                         FontSize="12" 
                                         Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>
                            <ToggleButton x:Name="AutoCheckUpdateToggle"
                                        Grid.Column="1"
                                        IsChecked="True"
                                        Style="{StaticResource MaterialDesignSwitchToggleButton}"
                                        VerticalAlignment="Center"
                                        Checked="ToggleButton_Changed"
                                        Unchecked="ToggleButton_Changed"/>
                        </Grid>

                        <Separator Margin="0,8,0,12" Background="{DynamicResource BorderBrush}"/>

                        <!-- 启动后关闭启动器 -->
                        <Grid Margin="0,0,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="游戏启动后关闭启动器" 
                                         FontSize="14" 
                                         Margin="0,0,0,4"/>
                                <TextBlock Text="减少内存占用" 
                                         FontSize="12" 
                                         Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>
                            <ToggleButton x:Name="CloseAfterLaunchToggle"
                                        Grid.Column="1"
                                        IsChecked="False"
                                        Style="{StaticResource MaterialDesignSwitchToggleButton}"
                                        VerticalAlignment="Center"
                                        Checked="ToggleButton_Changed"
                                        Unchecked="ToggleButton_Changed"/>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- 文件存储设置 -->
                <Border Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="文件存储" 
                                 FontSize="20" 
                                 FontWeight="SemiBold"
                                 Margin="0,0,0,15"/>

                        <!-- 配置文件位置 -->
                        <TextBlock Text="配置文件存储位置" 
                                 FontSize="14" 
                                 Margin="0,0,0,6"/>
                        <ComboBox x:Name="ConfigFileLocationComboBox"
                                Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                SelectionChanged="ConfigFileLocation_Changed_AutoSave"
                                Margin="0,0,0,8">
                            <ComboBoxItem Content="%APPDATA%\ObsMCLauncher\config.json（默认）" Tag="AppData"/>
                            <ComboBoxItem Content="运行目录\config.json" Tag="RunningDirectory"/>
                            <ComboBoxItem Content="自定义" Tag="Custom"/>
                        </ComboBox>
                        <Grid x:Name="CustomConfigFilePanel" Margin="0,0,0,12" Visibility="Collapsed">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="ConfigFileTextBox"
                                   Grid.Column="0"
                                   materialDesign:HintAssist.Hint="自定义配置文件路径"
                                   Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                   Margin="0,0,10,0"
                                   LostFocus="ConfigFileTextBox_LostFocus"
                                   TextChanged="ConfigFileTextBox_TextChanged"/>
                            <Button Grid.Column="1"
                                  Content="浏览"
                                  Style="{StaticResource MaterialDesignOutlinedButton}"
                                  Width="100"
                                  Click="BrowseConfigFile_Click"/>
                        </Grid>
                        <TextBlock x:Name="ConfigFileDisplayText"
                                 FontSize="12"
                                 Foreground="{DynamicResource TextSecondaryBrush}"
                                 TextWrapping="Wrap"
                                 Margin="0,0,0,12"/>

                        <!-- 账号文件位置 -->
                        <TextBlock Text="账号文件存储位置" 
                                 FontSize="14" 
                                 Margin="0,0,0,6"/>
                        <ComboBox x:Name="AccountFileLocationComboBox"
                                Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                SelectionChanged="AccountFileLocation_Changed_AutoSave"
                                Margin="0,0,0,8">
                            <ComboBoxItem Content="%APPDATA%\ObsMCLauncher\accounts.json（默认）" Tag="AppData"/>
                            <ComboBoxItem Content="运行目录\accounts.json" Tag="RunningDirectory"/>
                        </ComboBox>
                        <TextBlock x:Name="AccountFileDisplayText"
                                 FontSize="12"
                                 Foreground="{DynamicResource TextSecondaryBrush}"
                                 TextWrapping="Wrap"
                                 Margin="0,0,0,0"/>
                    </StackPanel>
                </Border>

                <!-- 下载设置 -->
                <Border Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="下载设置" 
                                 FontSize="20" 
                                 FontWeight="SemiBold"
                                 Margin="0,0,0,15"/>

                        <!-- 下载源 -->
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                    <TextBlock Text="下载源" 
                                             FontSize="14"/>
                                    <TextBlock Text=" (优先使用)" 
                                             FontSize="11" 
                                             Foreground="{DynamicResource TextTertiaryBrush}"
                                             VerticalAlignment="Bottom"
                                             Margin="5,0,0,1"/>
                                </StackPanel>
                                <TextBlock x:Name="DownloadSourceDescription"
                                         Text="使用BMCLAPI镜像加速下载，适合中国大陆用户" 
                                         FontSize="12" 
                                         Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>
                            <ComboBox x:Name="DownloadSourceComboBox"
                                    Grid.Column="1"
                                    Width="250"
                                    Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                    VerticalAlignment="Center"
                                    SelectionChanged="DownloadSourceComboBox_SelectionChanged_AutoSave">
                                <ComboBoxItem Content="BMCLAPI (推荐-中国大陆)" IsSelected="True"/>
                                <ComboBoxItem Content="官方源"/>
                            </ComboBox>
                        </Grid>

                        <Separator Margin="0,8,0,12" Background="{DynamicResource BorderBrush}"/>

                        <!-- 最大下载线程 -->
                        <Grid Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="最大下载线程" 
                                         FontSize="14" 
                                         Margin="0,0,0,4"/>
                                <TextBlock Text="同时下载的文件数量" 
                                         FontSize="12" 
                                         Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>
                            <ComboBox x:Name="MaxDownloadThreadsComboBox"
                                    Grid.Column="1"
                                    Width="150"
                                    Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                    VerticalAlignment="Center"
                                    SelectionChanged="ComboBox_Changed">
                                <ComboBoxItem Content="4 线程"/>
                                <ComboBoxItem Content="8 线程" IsSelected="True"/>
                                <ComboBoxItem Content="16 线程"/>
                                <ComboBoxItem Content="32 线程"/>
                            </ComboBox>
                        </Grid>

                        <Separator Margin="0,8,0,12" Background="{DynamicResource BorderBrush}"/>

                        <!-- 完整下载游戏资源文件 -->
                        <Grid Margin="0,0,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="下载游戏时完整下载所有资源文件" 
                                         FontSize="14" 
                                         Margin="0,0,0,4"/>
                                <TextBlock Text="下载游戏依赖库、声音、语言、纹理等全部资源文件" 
                                         FontSize="12" 
                                         Foreground="{DynamicResource TextSecondaryBrush}"
                                         TextWrapping="Wrap"/>
                            </StackPanel>
                                    <ToggleButton x:Name="DownloadAssetsToggle"
                                                Grid.Column="1"
                                                IsChecked="True"
                                                Checked="DownloadAssetsToggle_Changed"
                                                Unchecked="DownloadAssetsToggle_Changed"
                                                Style="{StaticResource MaterialDesignSwitchToggleButton}"
                                                VerticalAlignment="Center"/>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- 底部按钮 -->
                <StackPanel Orientation="Horizontal" 
                          HorizontalAlignment="Right"
                          Margin="0,5,0,15">
                    <Button Content="测试下载源"
                          Style="{StaticResource MaterialDesignOutlinedButton}"
                          Margin="0,0,15,0"
                          Width="130"
                          Click="TestDownloadSource_Click"/>
                    <Button Content="恢复默认设置"
                          Style="{StaticResource MaterialDesignOutlinedButton}"
                          Width="150"
                          Click="ResetButton_Click"/>
                </StackPanel>

            </StackPanel>
        </Grid>
    </ScrollViewer>

    </Grid>
</Page>

