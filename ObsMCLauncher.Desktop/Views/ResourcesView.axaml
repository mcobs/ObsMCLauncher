<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ObsMCLauncher.Desktop.ViewModels"
             xmlns:converters="using:ObsMCLauncher.Desktop.Converters"
             x:Class="ObsMCLauncher.Desktop.Views.ResourcesView"
             x:DataType="vm:ResourcesViewModel"
             x:Name="Root">

  <Grid RowDefinitions="Auto,Auto,*" Margin="16">

    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <StackPanel Grid.Row="0" Spacing="6" IsVisible="{Binding IsListVisible}">
      <TextBlock Text="èµ„æºä¸­å¿ƒ" FontSize="24" FontWeight="Bold" />
      <TextBlock Text="ä¸‹è½½ MODã€æè´¨åŒ…ã€å…‰å½±ã€æ•°æ®åŒ…å’Œæ•´åˆåŒ…" Opacity="0.75" />
    </StackPanel>

    <!-- Tabs + ç­›é€‰æ  -->
    <Border Grid.Row="1" Margin="0,0,0,10" CornerRadius="10"
            Background="{DynamicResource SurfaceBrush}" Padding="10"
            IsVisible="{Binding IsListVisible}">
      <StackPanel Spacing="8">

        <!-- åˆ†ç±» Tabs (ç´§å‡‘å•è¡Œæ¨¡å¼) -->
        <StackPanel Orientation="Horizontal" Spacing="12">
          <TextBlock Text="èµ„æºç±»åž‹:" FontSize="12" FontWeight="SemiBold" Opacity="0.6" VerticalAlignment="Center" />
          <StackPanel Orientation="Horizontal" Spacing="4">
            <RadioButton Content="MOD" GroupName="resType" 
                         IsChecked="{Binding CurrentResourceType, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=Mods}"
                         Command="{Binding ChangeTypeCommand}" CommandParameter="Mods" />
            <RadioButton Content="æè´¨åŒ…" GroupName="resType" 
                         IsChecked="{Binding CurrentResourceType, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=Textures}"
                         Command="{Binding ChangeTypeCommand}" CommandParameter="Textures" />
            <RadioButton Content="å…‰å½±" GroupName="resType" 
                         IsChecked="{Binding CurrentResourceType, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=Shaders}"
                         Command="{Binding ChangeTypeCommand}" CommandParameter="Shaders" />
            <RadioButton Content="æ•°æ®åŒ…" GroupName="resType" 
                         IsChecked="{Binding CurrentResourceType, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=Datapacks}"
                         Command="{Binding ChangeTypeCommand}" CommandParameter="Datapacks" />
            <RadioButton Content="æ•´åˆåŒ…" GroupName="resType" 
                         IsChecked="{Binding CurrentResourceType, Converter={x:Static converters:StringEqualsConverter.Instance}, ConverterParameter=Modpacks}"
                         Command="{Binding ChangeTypeCommand}" CommandParameter="Modpacks" />
          </StackPanel>
        </StackPanel>

        <!-- ç­›é€‰è¯¦æƒ… -->
        <Grid ColumnDefinitions="*,70,130,130,130,160" RowDefinitions="Auto" ColumnSpacing="10">
          
          <!-- 1. æœç´¢æ¡† -->
          <StackPanel Grid.Column="0" Spacing="4">
            <TextBlock Text="å…³é”®è¯æœç´¢" FontSize="12" FontWeight="SemiBold" Opacity="0.6" />
            <TextBox Text="{Binding Query}" Watermark="è¾“å…¥èµ„æºåç§°..." Height="32" VerticalAlignment="Center" />
          </StackPanel>

          <!-- 2. æœç´¢æŒ‰é’® (ç§»è‡³æœç´¢æ¡†åŽ) -->
          <StackPanel Grid.Column="1" Spacing="4">
            <TextBlock Text=" " FontSize="12" /> <!-- å ä½å¯¹é½ -->
            <Button Content="æœç´¢" Classes="accent" 
                    Command="{Binding SearchCommand}" IsEnabled="{Binding !IsLoading}" 
                    Height="32" Padding="0"
                    HorizontalAlignment="Stretch" HorizontalContentAlignment="Center" VerticalAlignment="Center" />
          </StackPanel>

          <!-- 3. ä¸‹è½½æº -->
          <StackPanel Grid.Column="2" Spacing="4">
            <TextBlock Text="æœç´¢æ¥æº" FontSize="12" FontWeight="SemiBold" Opacity="0.6" />
            <ComboBox HorizontalAlignment="Stretch"
                      SelectedIndex="{Binding CurrentSourceIndex}">
              <ComboBoxItem Content="CurseForge" />
              <ComboBoxItem Content="Modrinth" />
            </ComboBox>
          </StackPanel>

          <!-- 4. é€‚ç”¨ç‰ˆæœ¬ç­›é€‰ -->
          <StackPanel Grid.Column="3" Spacing="4">
            <TextBlock Text="é€‚ç”¨æ¸¸æˆç‰ˆæœ¬" FontSize="12" FontWeight="SemiBold" Opacity="0.6" />
            <ComboBox HorizontalAlignment="Stretch"
                      ItemsSource="{Binding VersionFilters}"
                      SelectedItem="{Binding VersionFilter}" />
          </StackPanel>

          <!-- 5. æŽ’åºæ–¹å¼ -->
          <StackPanel Grid.Column="4" Spacing="4">
            <TextBlock Text="æŽ’åºæ–¹å¼" FontSize="12" FontWeight="SemiBold" Opacity="0.6" />
            <ComboBox HorizontalAlignment="Stretch"
                      ItemsSource="{Binding AvailableSortOptions}"
                      SelectedIndex="{Binding SortFieldIndex}">
              <ComboBox.ItemTemplate>
                <DataTemplate>
                  <TextBlock Text="{Binding Name}" />
                </DataTemplate>
              </ComboBox.ItemTemplate>
            </ComboBox>
          </StackPanel>

          <!-- 6. æ¸¸æˆç‰ˆæœ¬ -->
          <StackPanel Grid.Column="5" Spacing="4">
            <TextBlock Text="å®‰è£…ç›®æ ‡ç‰ˆæœ¬" FontSize="12" FontWeight="SemiBold" Opacity="0.6" />
            <ComboBox HorizontalAlignment="Stretch"
                      ItemsSource="{Binding InstalledVersions}"
                      SelectedItem="{Binding SelectedVersionId}"
                      IsEnabled="{Binding HasInstalledVersions}"
                      PlaceholderText="è¯·é€‰æ‹©ç‰ˆæœ¬" />
            <TextBlock Text="{Binding VersionHintText}" FontSize="10" Foreground="#E74C3C" 
                       IsVisible="{Binding !HasInstalledVersions}" />
          </StackPanel>
        </Grid>

        <Separator Height="1" Background="{DynamicResource BorderBrush}" Opacity="0.3" Margin="0,4" />
        <TextBlock Text="{Binding Status}" Opacity="0.8" FontSize="12" />

      </StackPanel>
    </Border>

    <!-- åˆ—è¡¨åŒºåŸŸ -->
    <Border Grid.Row="2" CornerRadius="10" Background="{DynamicResource SurfaceBrush}">
      <Grid>
        <ContentControl Content="{Binding DetailViewModel}" IsVisible="{Binding DetailViewModel, Converter={x:Static converters:NotNullConverter.Instance}}" />
        <!-- åŠ è½½çŠ¶æ€ï¼šç®€åŒ–éª¨æž¶å± -->
        <ItemsControl IsVisible="{Binding IsLoading}" Margin="20">
          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <Border CornerRadius="8" Padding="12" Margin="0,0,0,12"
                      Background="{DynamicResource SurfaceElevatedBrush}">
                <Grid ColumnDefinitions="80,*" RowDefinitions="Auto,Auto,Auto">
                  <Border Width="60" Height="60" CornerRadius="8" Background="{DynamicResource SurfaceHoverBrush}" />
                  <StackPanel Grid.Column="1" Spacing="8">
                    <Border Height="18" Width="260" Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="4" />
                    <Border Height="14" Width="420" Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="4" />
                    <Border Height="12" Width="320" Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="4" />
                  </StackPanel>
                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- ç»“æžœåˆ—è¡¨ï¼ˆå¡ç‰‡å¼ï¼‰ -->
        <ScrollViewer IsVisible="{Binding DetailViewModel, Converter={x:Static ObjectConverters.IsNull}}">
          <ItemsControl ItemsSource="{Binding Results}" Margin="20">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border CornerRadius="8" Padding="12" Margin="0,0,0,12"
                        Background="{DynamicResource SurfaceElevatedBrush}">
                  <Grid ColumnDefinitions="80,*,Auto" RowDefinitions="Auto,Auto,Auto">

                    <Border Grid.RowSpan="3" Width="60" Height="60" CornerRadius="8"
                            Background="{DynamicResource SurfaceHoverBrush}" VerticalAlignment="Top">
                      <Image Source="{Binding Icon}" Width="60" Height="60" />
                    </Border>

                    <TextBlock Grid.Column="1" Grid.Row="0" Text="{Binding DisplayName}" FontSize="16" FontWeight="SemiBold"
                               TextTrimming="CharacterEllipsis" Margin="0,0,0,4" />

                    <TextBlock Grid.Column="1" Grid.Row="1" Text="{Binding Description}" Opacity="0.75"
                               TextWrapping="Wrap" MaxHeight="40" TextTrimming="CharacterEllipsis" Margin="0,0,0,8" />

                    <StackPanel Grid.Column="1" Grid.Row="2" Orientation="Horizontal" Spacing="16" Opacity="0.8" VerticalAlignment="Center">
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="ðŸ‘¤" Opacity="0.5" />
                        <TextBlock Text="{Binding Author}" FontSize="12" />
                      </StackPanel>
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="ðŸ“¥" Opacity="0.5" />
                        <TextBlock Text="{Binding Downloads}" FontSize="12" />
                      </StackPanel>
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="ðŸ·ï¸" Opacity="0.5" />
                        <TextBlock Text="{Binding VersionDisplay, StringFormat=ç‰ˆæœ¬: {0}}" FontSize="12" />
                      </StackPanel>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Grid.Row="0" Grid.RowSpan="3" Orientation="Vertical" Spacing="6" VerticalAlignment="Center" Margin="12,0,0,0">
                      <Button Content="è¯¦æƒ…" 
                              Command="{Binding #Root.((vm:ResourcesViewModel)DataContext).OpenDetailCommand}"
                              CommandParameter="{Binding}" />
                      <Button Content="ä¸‹è½½" Classes="accent" 
                              Command="{Binding #Root.((vm:ResourcesViewModel)DataContext).DownloadCommand}"
                              CommandParameter="{Binding}" />
                    </StackPanel>

                  </Grid>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </ScrollViewer>
      </Grid>
    </Border>

  </Grid>
</UserControl>
