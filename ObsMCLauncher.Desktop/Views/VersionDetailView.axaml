<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ObsMCLauncher.Desktop.ViewModels"
             xmlns:converters="using:ObsMCLauncher.Desktop.Converters"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="700"
             x:Class="ObsMCLauncher.Desktop.Views.VersionDetailView"
             x:DataType="vm:VersionDetailViewModel">

  <UserControl.Resources>
    <converters:BitmapAssetValueConverter x:Key="BitmapConverter"/>
  </UserControl.Resources>

  <ScrollViewer VerticalScrollBarVisibility="Auto">
    <Grid Margin="24">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="*"/>
        <RowDefinition Height="Auto"/>
      </Grid.RowDefinitions>

      <!-- 返回按钮和标题 -->
      <StackPanel Grid.Row="0" Margin="0,0,0,12">
        <Button Command="{Binding BackCommand}"
                Classes="outline"
                HorizontalAlignment="Left"
                Padding="5"
                Margin="-5,0,0,10">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <TextBlock Text="←" FontSize="16" VerticalAlignment="Center"/>
            <TextBlock Text="返回版本列表" VerticalAlignment="Center" FontSize="14"/>
          </StackPanel>
        </Button>

        <Grid ColumnDefinitions="Auto,*">
          <Image Grid.Column="0" Source="{Binding VersionInfo.IconPath, Converter={StaticResource BitmapConverter}}" Width="32" Height="32" Margin="0,0,12,0" VerticalAlignment="Center"/>
          <TextBlock Grid.Column="1" Text="{Binding SelectedMcVersion, StringFormat='Minecraft {0}'}"
                     FontSize="24"
                     FontWeight="Bold"
                     VerticalAlignment="Center"/>
        </Grid>
        <TextBlock Text="配置版本信息和加载器选项"
                   FontSize="13"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   Margin="0,4,0,0"/>
      </StackPanel>

      <!-- 版本信息卡片 -->
      <Border Grid.Row="1"
              Background="{DynamicResource SurfaceBrush}"
              CornerRadius="10"
              Padding="20"
              Margin="0,0,0,16">
        <StackPanel Spacing="15">
          <TextBlock Text="版本信息" FontSize="16" FontWeight="SemiBold"/>

          <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto">
            <!-- 版本号 -->
            <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,10,12">
              <TextBlock Text="版本号" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,8"/>
              <TextBlock Text="{Binding SelectedMcVersion}" FontSize="16" FontWeight="SemiBold"/>
            </StackPanel>

            <!-- 发布日期 -->
            <StackPanel Grid.Row="0" Grid.Column="1" Margin="10,0,0,12">
              <TextBlock Text="发布日期" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,8"/>
              <TextBlock Text="{Binding ReleaseDate}" FontSize="16" FontWeight="SemiBold"/>
            </StackPanel>

            <!-- 版本类型 -->
            <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,10,12">
              <TextBlock Text="版本类型" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,8"/>
              <Border Background="{Binding VersionTypeColor}" CornerRadius="4" Padding="8,4" HorizontalAlignment="Left">
                <TextBlock Text="{Binding VersionTypeText}" FontSize="13" FontWeight="SemiBold" Foreground="White"/>
              </Border>
            </StackPanel>

            <!-- 下载大小 -->
            <StackPanel Grid.Row="1" Grid.Column="1" Margin="10,0,0,12">
              <TextBlock Text="下载大小" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,8"/>
              <TextBlock Text="{Binding TotalDownloadSize}" FontSize="16" FontWeight="SemiBold"/>
            </StackPanel>
            
            <!-- 安装名称编辑 -->
            <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" Margin="0,8,0,0">
              <TextBlock Text="安装名称" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,8"/>
              <TextBox Text="{Binding CustomVersionName}" Watermark="自定义版本名称" FontSize="14"/>
              <TextBlock FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,8,0,0">
                <Run Text="提示：版本将安装到 "/>
                <Run Text=".minecraft/versions/" FontWeight="SemiBold"/>
                <Run Text="{Binding CustomVersionName}" FontWeight="SemiBold" Foreground="{DynamicResource PrimaryBrush}"/>
              </TextBlock>
            </StackPanel>
          </Grid>
        </StackPanel>
      </Border>

      <!-- 加载器选择 (WPF 1:1 风格) -->
      <Border Grid.Row="2" Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="25" Margin="0,0,0,16" BorderThickness="1" BorderBrush="{DynamicResource BorderBrush}">
        <StackPanel Spacing="15">
          <TextBlock Text="加载器选择" FontSize="18" FontWeight="SemiBold"/>
          <TextBlock Text="选择要安装的加载器（仅能选择一个，不选则安装原版）" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,10"/>

          <!-- RadioButton 组实现互斥选择 -->
          <StackPanel Spacing="12">
            <!-- Vanilla -->
            <RadioButton GroupName="LoaderGroup" IsChecked="{Binding IsVanillaSelected}">
              <StackPanel Orientation="Horizontal" Spacing="10">
                <Image Source="avares://ObsMCLauncher.Desktop/Assets/LoaderIcons/vanilla.png" Width="20" Height="20"/>
                <TextBlock Text="原版 (Vanilla)" VerticalAlignment="Center"/>
              </StackPanel>
            </RadioButton>

            <!-- Forge -->
            <Grid ColumnDefinitions="*,Auto">
              <RadioButton GroupName="LoaderGroup" IsChecked="{Binding IsForgeSelected}" VerticalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <Image Source="avares://ObsMCLauncher.Desktop/Assets/LoaderIcons/forge.png" Width="20" Height="20"/>
                  <TextBlock Text="Forge" VerticalAlignment="Center"/>
                </StackPanel>
              </RadioButton>
              <ComboBox Grid.Column="1" Width="180" IsEnabled="{Binding CanSelectForge}"
                        ItemsSource="{Binding ForgeVersionOptions}"
                        SelectedItem="{Binding ForgeVersion}"
                        PlaceholderText="选择版本"/>
            </Grid>

            <!-- NeoForge -->
            <Grid ColumnDefinitions="*,Auto">
              <RadioButton GroupName="LoaderGroup" IsChecked="{Binding IsNeoForgeSelected}" VerticalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <Image Source="avares://ObsMCLauncher.Desktop/Assets/LoaderIcons/neoforged.png" Width="20" Height="20"/>
                  <TextBlock Text="NeoForge" VerticalAlignment="Center"/>
                </StackPanel>
              </RadioButton>
              <ComboBox Grid.Column="1" Width="180" IsEnabled="{Binding CanSelectNeoForge}"
                        ItemsSource="{Binding NeoForgeVersionOptions}"
                        SelectedItem="{Binding NeoForgeVersion}"
                        PlaceholderText="选择版本"/>
            </Grid>

            <!-- Fabric -->
            <Grid ColumnDefinitions="*,Auto">
              <RadioButton GroupName="LoaderGroup" IsChecked="{Binding IsFabricSelected}" VerticalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <Image Source="avares://ObsMCLauncher.Desktop/Assets/LoaderIcons/fabric.png" Width="20" Height="20"/>
                  <TextBlock Text="Fabric" VerticalAlignment="Center"/>
                </StackPanel>
              </RadioButton>
              <ComboBox Grid.Column="1" Width="180" IsEnabled="{Binding CanSelectFabric}"
                        ItemsSource="{Binding FabricLoaderVersionOptions}"
                        SelectedItem="{Binding FabricLoaderVersion}"
                        PlaceholderText="选择版本"/>
            </Grid>

            <!-- Quilt -->
            <Grid ColumnDefinitions="*,Auto">
              <RadioButton GroupName="LoaderGroup" IsChecked="{Binding IsQuiltSelected}" VerticalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <Image Source="avares://ObsMCLauncher.Desktop/Assets/LoaderIcons/quilt.png" Width="20" Height="20"/>
                  <TextBlock Text="Quilt" VerticalAlignment="Center"/>
                </StackPanel>
              </RadioButton>
              <ComboBox Grid.Column="1" Width="180" IsEnabled="{Binding CanSelectQuilt}"
                        ItemsSource="{Binding QuiltLoaderVersionOptions}"
                        SelectedItem="{Binding QuiltLoaderVersion}"
                        PlaceholderText="选择版本"/>
            </Grid>

            <!-- OptiFine (新增强：独立或共用) -->
            <Separator Margin="0,8"/>
            <Grid ColumnDefinitions="*,Auto">
              <CheckBox IsChecked="{Binding IsOptiFineEnabled}" VerticalAlignment="Center">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <Image Source="avares://ObsMCLauncher.Desktop/Assets/LoaderIcons/optifine.png" Width="20" Height="20"/>
                  <TextBlock Text="OptiFine" VerticalAlignment="Center"/>
                </StackPanel>
              </CheckBox>
              <ComboBox Grid.Column="1" Width="180" IsEnabled="{Binding CanSelectOptiFine}"
                        ItemsSource="{Binding OptiFineVersionOptions}"
                        SelectedItem="{Binding SelectedOptiFineVersion}"
                        PlaceholderText="选择版本">
                <ComboBox.ItemTemplate>
                  <DataTemplate>
                    <TextBlock Text="{Binding FullVersion}"/>
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>
            </Grid>
          </StackPanel>
        </StackPanel>
      </Border>

      <!-- 底部操作按钮 -->
      <Grid Grid.Row="3" ColumnDefinitions="*,Auto" Margin="0,0,0,16">
        <StackPanel Grid.Column="0" VerticalAlignment="Center">
          <TextBlock Text="准备安装版本" FontSize="14" FontWeight="SemiBold"/>
          <TextBlock Text="点击「开始安装」将下载并安装该版本" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,8,0,0"/>
        </StackPanel>

        <Button Grid.Column="1" Content="开始安装" Height="50" Width="180" FontSize="16"
                Classes="accent" Background="{DynamicResource PrimaryBrush}" Foreground="White"
                Command="{Binding InstallCommand}" IsVisible="{Binding !IsBusy}"/>
      </Grid>

      <!-- 下载进度面板覆盖 (旧版WPF双进度条风格) -->
      <Border Grid.Row="0" Grid.RowSpan="4"
              Background="{DynamicResource SurfaceBrush}"
              CornerRadius="10"
              Padding="20"
              IsVisible="{Binding IsBusy}">
        <StackPanel Spacing="16">
          <!-- 标题 -->
          <Grid ColumnDefinitions="*,Auto" Margin="0,0,0,8">
            <StackPanel>
              <TextBlock Text="正在下载版本" FontSize="20" FontWeight="Bold" Margin="0,0,0,6"/>
              <TextBlock Text="{Binding SelectedMcVersion, StringFormat='Minecraft {0}'}" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}"/>
            </StackPanel>
            <TextBlock Grid.Column="1" Text="{Binding Progress, StringFormat='{}{0:F0}%'}"
                       FontSize="32" FontWeight="Bold" Foreground="{DynamicResource PrimaryBrush}" VerticalAlignment="Center"/>
          </Grid>

          <!-- 总体进度 -->
          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="总体进度" FontSize="14" FontWeight="SemiBold"/>
              <TextBlock Grid.Column="1" Text="{Binding FileCountStatus}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}"/>
            </Grid>
            <ProgressBar Height="10" Value="{Binding Progress}" Maximum="100"/>
          </StackPanel>

          <!-- 当前文件进度 -->
          <StackPanel Spacing="8">
            <Grid ColumnDefinitions="*,Auto">
              <TextBlock Text="当前文件" FontSize="14" FontWeight="SemiBold"/>
              <TextBlock Grid.Column="1" Text="{Binding CurrentFileProgress, StringFormat='{}{0:F0}%'}" FontSize="13" Foreground="{DynamicResource PrimaryBrush}"/>
            </Grid>
            <ProgressBar Height="8" Value="{Binding CurrentFileProgress}" Maximum="100"/>
          </StackPanel>

          <!-- 详细信息块 -->
          <Border Background="{DynamicResource SurfaceElevatedBrush}" CornerRadius="8" Padding="16">
            <StackPanel Spacing="10">
              <Grid ColumnDefinitions="Auto,*">
                <TextBlock Text="状态：" Foreground="{DynamicResource TextSecondaryBrush}"/>
                <TextBlock Grid.Column="1" Text="{Binding Status}" FontWeight="SemiBold"/>
              </Grid>

              <Grid ColumnDefinitions="Auto,*">
                <TextBlock Text="文件：" Foreground="{DynamicResource TextSecondaryBrush}"/>
                <TextBlock Grid.Column="1" Text="{Binding CurrentFileName}" TextTrimming="CharacterEllipsis"/>
              </Grid>

              <Grid ColumnDefinitions="Auto,*">
                <TextBlock Text="速度：" Foreground="{DynamicResource TextSecondaryBrush}"/>
                <TextBlock Grid.Column="1" Text="{Binding DownloadSpeed}"/>
              </Grid>

              <Grid ColumnDefinitions="Auto,*">
                <TextBlock Text="大小：" Foreground="{DynamicResource TextSecondaryBrush}"/>
                <TextBlock Grid.Column="1" Text="{Binding DownloadSizeStatus}"/>
              </Grid>
            </StackPanel>
          </Border>

          <!-- 取消按钮 -->
          <Button Content="取消下载" Command="{Binding CancelInstallCommand}" HorizontalAlignment="Center" Width="150" Classes="outline"/>
        </StackPanel>
      </Border>

    </Grid>
  </ScrollViewer>
</UserControl>
