<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ObsMCLauncher.Desktop.ViewModels"
             xmlns:converters="using:ObsMCLauncher.Desktop.Converters"
             x:Class="ObsMCLauncher.Desktop.Views.AccountManagementView"
             x:DataType="vm:AccountManagementViewModel"
             x:Name="AccountPage">

  <Grid>
    <ScrollViewer VerticalScrollBarVisibility="Auto">
      <Grid Margin="24" RowDefinitions="Auto,Auto,Auto,Auto">

      <!-- æ ‡é¢˜åŒºåŸŸ -->
      <StackPanel Grid.Row="0">
        <TextBlock Text="è´¦å·ç®¡ç†" FontSize="28" FontWeight="Bold" Margin="0,0,0,8" />
        <TextBlock Text="ç®¡ç†æ‚¨çš„ Minecraft è´¦å·ï¼Œæ”¯æŒå¾®è½¯è´¦æˆ·å’Œç¦»çº¿æ¨¡å¼" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,16" />
      </StackPanel>

      <!-- æ·»åŠ è´¦å·æŒ‰é’®åŒº -->
      <Border Grid.Row="1" Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="20" Margin="0,0,0,16">
        <Grid ColumnDefinitions="*,Auto,Auto,Auto">
          <StackPanel Grid.Column="0" VerticalAlignment="Center">
            <TextBlock Text="æ·»åŠ æ–°è´¦å·" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,5" />
            <TextBlock Text="ç™»å½•å¾®è½¯è´¦æˆ·ã€å¤–ç½®ç™»å½•æˆ–åˆ›å»ºç¦»çº¿è´¦å·" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" />
          </StackPanel>

          <Button Grid.Column="1" Background="{DynamicResource PrimaryBrush}" Foreground="White" Margin="0,0,15,0" Padding="16,14" MinWidth="120" Height="48" Command="{Binding StartMicrosoftLoginCommand}" IsEnabled="{Binding !IsMicrosoftLoginRunning}">
            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
              <TextBlock Text="âŠž" FontSize="16" VerticalAlignment="Center" />
              <TextBlock Text="å¾®è½¯è´¦æˆ·" FontSize="14" VerticalAlignment="Center" />
            </StackPanel>
          </Button>

          <Button Grid.Column="2" Margin="0,0,15,0" Padding="16,14" MinWidth="120" Height="48" Command="{Binding AddYggdrasilAccountCommand}">
            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
              <TextBlock Text="ðŸ›¡" FontSize="16" VerticalAlignment="Center" />
              <TextBlock Text="å¤–ç½®ç™»å½•" FontSize="14" VerticalAlignment="Center" />
            </StackPanel>
          </Button>

          <Button Grid.Column="3" Padding="16,14" MinWidth="120" Height="48" Command="{Binding ShowAddOfflinePanelCommand}">
            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
              <TextBlock Text="ðŸ‘¤" FontSize="16" VerticalAlignment="Center" />
              <TextBlock Text="ç¦»çº¿è´¦æˆ·" FontSize="14" VerticalAlignment="Center" />
            </StackPanel>
          </Button>
        </Grid>
      </Border>

      <!-- æ·»åŠ ç¦»çº¿è´¦å·é¢æ¿ -->
      <Border Grid.Row="2" Background="{DynamicResource SurfaceElevatedBrush}" CornerRadius="10" Padding="25" Margin="0,0,0,20" IsVisible="{Binding IsAddOfflinePanelVisible}">
        <StackPanel>
          <TextBlock Text="æ·»åŠ ç¦»çº¿è´¦æˆ·" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,20" />
          <TextBlock Text="ç”¨æˆ·å" FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,8" />
          <TextBox Watermark="è¯·è¾“å…¥ç”¨æˆ·åï¼ˆ3-16ä¸ªå­—ç¬¦ï¼‰" Text="{Binding UsernameInput}" FontSize="14" MaxLength="16" Margin="0,0,0,20" />
          <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="15">
            <Button Content="å–æ¶ˆ" Width="100" Command="{Binding CancelAddOfflineCommand}" />
            <Button Content="ç¡®è®¤æ·»åŠ " Width="100" Background="{DynamicResource PrimaryBrush}" Foreground="White" Command="{Binding AddOfflineCommand}" />
          </StackPanel>
        </StackPanel>
      </Border>

      <!-- è´¦å·åˆ—è¡¨ -->
      <StackPanel Grid.Row="3">
        <TextBlock Text="æˆ‘çš„è´¦å·" FontSize="20" FontWeight="SemiBold" Margin="0,0,0,15" />
        <ItemsControl ItemsSource="{Binding Accounts}" >
          <ItemsControl.ItemTemplate>
            <DataTemplate>
              <Border Background="{DynamicResource SurfaceElevatedBrush}" CornerRadius="10" Padding="20" Margin="0,0,0,15">
                <Grid ColumnDefinitions="Auto,*,Auto" VerticalAlignment="Center">
                  <!-- å¤´åƒåŒºåŸŸï¼šå¸¦ç±»åž‹å åŠ å›¾æ ‡ -->
                  <Panel Margin="0,0,20,0">
                    <Border Width="60" Height="60" CornerRadius="8" Background="{DynamicResource SurfaceBrush}" ClipToBounds="True">
                      <Image Source="{Binding Avatar}" Stretch="Uniform" />
                    </Border>
                    <!-- è´¦å·ç±»åž‹å°å›¾æ ‡ (å³ä¸‹è§’) -->
                    <Border Width="24" Height="24" 
                            CornerRadius="12" 
                            Background="{DynamicResource SurfaceElevatedBrush}"
                            BorderThickness="2"
                            BorderBrush="{DynamicResource SurfaceBrush}"
                            HorizontalAlignment="Right" 
                            VerticalAlignment="Bottom"
                            Margin="0,0,-6,-6"
                            BoxShadow="0 2 4 0 #40000000">
                      <TextBlock Text="{Binding Type, Converter={x:Static converters:EnumToChineseTextConverter.Instance}, ConverterParameter='Icon'}" 
                                 FontSize="12" 
                                 HorizontalAlignment="Center" 
                                 VerticalAlignment="Center" />
                    </Border>
                  </Panel>

                  <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock FontSize="18" FontWeight="SemiBold">
                      <Run Text="{Binding Username}" />
                      <Run Text=" [é»˜è®¤]" Foreground="{DynamicResource PrimaryBrush}" FontSize="13" />
                    </TextBlock>
                    <TextBlock Text="{Binding Type, Converter={x:Static converters:EnumToChineseTextConverter.Instance}}" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,5,0,0" />
                  </StackPanel>

                  <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">
                    <Button Command="{Binding #AccountPage.DataContext.RefreshAccountCommand}" 
                            CommandParameter="{Binding}"
                            IsEnabled="{Binding #AccountPage.DataContext.IsRefreshing}">
                      <StackPanel Orientation="Horizontal" Spacing="6">
                        <Panel Width="16" Height="16">
                          <TextBlock Text="&#x21BB;" FontSize="14" VerticalAlignment="Center" HorizontalAlignment="Center"
                                     IsVisible="{Binding #AccountPage.DataContext.IsRefreshing, Converter={x:Static converters:NotConverter.Instance}}"/>
                          <ProgressBar IsIndeterminate="True" Width="14" Height="14"
                                       IsVisible="{Binding #AccountPage.DataContext.IsRefreshing}"/>
                        </Panel>
                        <TextBlock Text="åˆ·æ–°" VerticalAlignment="Center"/>
                      </StackPanel>
                    </Button>
                    <Button Content="è®¾ä¸ºé»˜è®¤" 
                            Command="{Binding #AccountPage.DataContext.SetDefaultSelectedCommand}" 
                            CommandParameter="{Binding}"
                            IsEnabled="{Binding !IsDefault, FallbackValue=False}"/>
                    <Button Content="åˆ é™¤" 
                            Command="{Binding #AccountPage.DataContext.DeleteSelectedCommand}" 
                            CommandParameter="{Binding}" />
                  </StackPanel>
                </Grid>
              </Border>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

        <TextBlock Text="{Binding Status}" Foreground="{DynamicResource TextTertiaryBrush}" Margin="0,8,0,0" />
      </StackPanel>

    </Grid>
  </ScrollViewer>

  <!-- å¤–ç½®ç™»å½•å¯¹è¯æ¡† -->
  <Border Background="#80000000"
          IsVisible="{Binding IsYggdrasilLoginDialogOpen}"
          HorizontalAlignment="Stretch"
          VerticalAlignment="Stretch">
    <Border Background="{DynamicResource SurfaceElevatedBrush}"
            CornerRadius="12" Padding="24"
            Width="500" MaxHeight="600"
            HorizontalAlignment="Center" VerticalAlignment="Center">
      <Grid RowDefinitions="Auto,*,Auto">
        <!-- æ ‡é¢˜æ  -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
          <TextBlock Text="å¤–ç½®ç™»å½•" FontSize="24" FontWeight="Bold" Foreground="{DynamicResource TextBrush}"/>
          <TextBlock Text="ä½¿ç”¨ Yggdrasil è®¤è¯æœåŠ¡å™¨ç™»å½•" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,4,0,0"/>
        </StackPanel>

        <!-- å†…å®¹åŒº -->
        <Panel Grid.Row="1">
          <!-- ç™»å½•è§†å›¾ -->
          <ScrollViewer IsVisible="{Binding !YggdrasilLoginDialog.ShowServerManagement}">
            <StackPanel Spacing="15">
              <TextBlock Text="è®¤è¯æœåŠ¡å™¨" FontSize="14" FontWeight="SemiBold"/>
              <ComboBox HorizontalAlignment="Stretch" 
                        ItemsSource="{Binding YggdrasilLoginDialog.Servers}" 
                        SelectedItem="{Binding YggdrasilLoginDialog.SelectedServer}">
                <ComboBox.ItemTemplate>
                  <DataTemplate>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <TextBlock Text="ðŸ›¡" VerticalAlignment="Center"/>
                      <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                    </StackPanel>
                  </DataTemplate>
                </ComboBox.ItemTemplate>
              </ComboBox>

              <Button Content="ç®¡ç†æœåŠ¡å™¨" Command="{Binding YggdrasilLoginDialog.ToggleServerManagementCommand}" Classes="outline"/>

              <Border Background="{DynamicResource SurfaceElevatedBrush}" CornerRadius="8" Padding="20">
                <StackPanel Spacing="10">
                  <TextBlock Text="è´¦å·ä¿¡æ¯" FontSize="14" FontWeight="SemiBold"/>
                  
                  <StackPanel Spacing="5">
                    <TextBlock Text="ç”¨æˆ·å/é‚®ç®±" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}"/>
                    <TextBox Text="{Binding YggdrasilLoginDialog.Username}" Watermark="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±"/>
                  </StackPanel>

                  <StackPanel Spacing="5">
                    <TextBlock Text="å¯†ç " FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}"/>
                    <TextBox Text="{Binding YggdrasilLoginDialog.Password}" PasswordChar="*" Watermark="è¯·è¾“å…¥å¯†ç "/>
                  </StackPanel>
                </StackPanel>
              </Border>

              <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="6" Padding="12">
                <StackPanel Orientation="Horizontal" Spacing="10">
                  <TextBlock Text="â„¹" Foreground="{DynamicResource PrimaryBrush}" VerticalAlignment="Top"/>
                  <TextBlock Text="å¤–ç½®ç™»å½•éœ€è¦åœ¨ç¬¬ä¸‰æ–¹è®¤è¯æœåŠ¡å™¨æ³¨å†Œè´¦å·ã€‚æŽ¨èä½¿ç”¨ LittleSkin æœåŠ¡ã€‚" 
                             FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" TextWrapping="Wrap"/>
                </StackPanel>
              </Border>
            </StackPanel>
          </ScrollViewer>

          <!-- æœåŠ¡å™¨ç®¡ç†è§†å›¾ -->
          <ScrollViewer IsVisible="{Binding YggdrasilLoginDialog.ShowServerManagement}">
            <StackPanel Spacing="15">
              <Button Content="â† è¿”å›žç™»å½•" Command="{Binding YggdrasilLoginDialog.ToggleServerManagementCommand}" Classes="outline"/>
              <TextBlock Text="ç®¡ç†è®¤è¯æœåŠ¡å™¨" FontSize="20" FontWeight="Bold"/>
              
              <Border Background="{DynamicResource SurfaceElevatedBrush}" CornerRadius="8" Padding="15">
                <StackPanel Spacing="10">
                  <TextBlock Text="æ·»åŠ æ–°æœåŠ¡å™¨" FontWeight="SemiBold"/>
                  <TextBox Text="{Binding YggdrasilLoginDialog.NewServerName}" Watermark="æœåŠ¡å™¨åç§°"/>
                  <TextBox Text="{Binding YggdrasilLoginDialog.NewServerUrl}" Watermark="æœåŠ¡å™¨åœ°å€ (å¦‚ littleskin.cn)"/>
                  <Button Content="æ·»åŠ " Command="{Binding YggdrasilLoginDialog.AddServerCommand}" HorizontalAlignment="Right" Classes="accent"/>
                </StackPanel>
              </Border>

              <ItemsControl ItemsSource="{Binding YggdrasilLoginDialog.Servers}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Background="{DynamicResource SurfaceElevatedBrush}" CornerRadius="8" Padding="12" Margin="0,0,0,8">
                      <Grid ColumnDefinitions="*,Auto">
                        <StackPanel>
                          <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                          <TextBlock Text="{Binding ApiUrl}" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        </StackPanel>
                        <Button Grid.Column="1" Content="åˆ é™¤" 
                                Command="{Binding $parent[UserControl].((vm:AccountManagementViewModel)DataContext).YggdrasilLoginDialog.DeleteServerCommand}" 
                                CommandParameter="{Binding}"
                                IsVisible="{Binding !IsBuiltIn}" Classes="danger"/>
                      </Grid>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
            </StackPanel>
          </ScrollViewer>

          <!-- åŠ è½½/ç™»å½•ä¸­é®ç½© -->
          <Border Background="{DynamicResource BackgroundBrush}" Opacity="0.8" IsVisible="{Binding YggdrasilLoginDialog.IsLoggingIn}" CornerRadius="8">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="10">
              <ProgressBar IsIndeterminate="True" Width="100"/>
              <TextBlock Text="{Binding YggdrasilLoginDialog.StatusMessage}" HorizontalAlignment="Center"/>
            </StackPanel>
          </Border>

          <!-- è§’è‰²é€‰æ‹©é®ç½© -->
          <Border Background="{DynamicResource BackgroundBrush}" Opacity="0.95" IsVisible="{Binding YggdrasilLoginDialog.ShowProfileSelection}" CornerRadius="8">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="16" MaxWidth="350">
              <TextBlock Text="é€‰æ‹©è§’è‰²" FontSize="18" FontWeight="Bold" HorizontalAlignment="Center"/>
              <TextBlock Text="æ­¤è´¦å·æœ‰å¤šä¸ªæ¸¸æˆè§’è‰²ï¼Œè¯·é€‰æ‹©ä¸€ä¸ª" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center" TextWrapping="Wrap"/>
              
              <ItemsControl ItemsSource="{Binding YggdrasilLoginDialog.AvailableProfiles}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate>
                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="6" Padding="12" Margin="0,0,0,8"
                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                      <RadioButton GroupName="ProfileGroup" 
                                   Content="{Binding Name}"
                                   IsChecked="{Binding IsSelected}"
                                   FontSize="14" FontWeight="SemiBold"/>
                    </Border>
                  </DataTemplate>
                </ItemsControl.ItemTemplate>
              </ItemsControl>
              
              <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="12" Margin="0,8,0,0">
                <Button Content="å–æ¶ˆ" Command="{Binding YggdrasilLoginDialog.CancelProfileSelectionCommand}" Classes="outline" MinWidth="80"/>
                <Button Content="ç¡®è®¤" Command="{Binding YggdrasilLoginDialog.ConfirmProfileCommand}" Classes="accent" MinWidth="80"/>
              </StackPanel>
            </StackPanel>
          </Border>
        </Panel>

        <!-- åº•éƒ¨æŒ‰é’® -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="15" Margin="0,20,0,0">
          <Button Content="å–æ¶ˆ" Width="100" Command="{Binding CancelYggdrasilLoginCommand}" Classes="outline"/>
          <Button Content="ç™»å½•" Width="100" Command="{Binding YggdrasilLoginDialog.LoginCommand}" IsVisible="{Binding !YggdrasilLoginDialog.ShowServerManagement}" Classes="accent"/>
        </StackPanel>
      </Grid>
    </Border>
  </Border>
  </Grid>

</UserControl>
