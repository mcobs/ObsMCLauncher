<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ObsMCLauncher.Desktop.ViewModels"
             xmlns:views="using:ObsMCLauncher.Desktop.Views"
             xmlns:converters="using:ObsMCLauncher.Desktop.Converters"
             x:Class="ObsMCLauncher.Desktop.Views.HomeView"
             x:DataType="vm:HomeViewModel">

  <UserControl.Resources>
    <converters:BitmapAssetValueConverter x:Key="BitmapConverter"/>
  </UserControl.Resources>

  <UserControl.Styles>
    <!-- å¡ç‰‡æ‚¬åœç¼©æ”¾åŠ¨ç”» -->
    <Style Selector="Border.home-card">
      <Setter Property="Transitions">
        <Transitions>
          <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" Easing="CubicEaseOut"/>
        </Transitions>
      </Setter>
      <Setter Property="RenderTransform" Value="scale(1.0)"/>
    </Style>
    <Style Selector="Border.home-card:pointerover">
      <Setter Property="RenderTransform" Value="scale(1.02)"/>
      <Setter Property="Background" Value="{DynamicResource SurfaceHoverBrush}"/>
    </Style>
  </UserControl.Styles>

  <Grid>
    <ScrollViewer VerticalScrollBarVisibility="Auto">
      <Grid Margin="24" RowDefinitions="Auto,*,Auto">
        
        <!-- 1. æ¬¢è¿Žæ¨ªå¹… (Banner) -->
        <Border Grid.Row="0"
                CornerRadius="16"
                Margin="0,0,0,16"
                Height="200"
                ClipToBounds="True"
                BoxShadow="0 0 30 0 #4010B981">
          <Border.Background>
            <LinearGradientBrush StartPoint="0%,0%" EndPoint="100%,100%">
              <GradientStop Color="#1e3a8a" Offset="0"/>
              <GradientStop Color="#059669" Offset="1"/>
            </LinearGradientBrush>
          </Border.Background>
          
          <Panel>
            <!-- è£…é¥°æ€§èƒŒæ™¯å›¾æ¡ˆ (1:1 è¿˜åŽŸ) -->
            <Canvas HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
              <!-- å¤§åœ†å½¢è£…é¥° -->
              <Ellipse Width="200" Height="200" 
                       Canvas.Right="-50" Canvas.Top="-50"
                       Fill="White" Opacity="0.05"/>
              <Ellipse Width="150" Height="150" 
                       Canvas.Left="-30" Canvas.Bottom="-30"
                       Fill="White" Opacity="0.08"/>
              
              <!-- è¡¥é½çš„çŸ©å½¢è£…é¥° -->
              <Rectangle Width="40" Height="40" 
                        Canvas.Right="120" Canvas.Top="60"
                        Fill="White" Opacity="0.1"
                        RadiusX="4" RadiusY="4">
                <Rectangle.RenderTransform>
                  <RotateTransform Angle="15"/>
                </Rectangle.RenderTransform>
              </Rectangle>

              <Rectangle Width="30" Height="30" 
                        Canvas.Left="80" Canvas.Bottom="80"
                        Fill="White" Opacity="0.12"
                        RadiusX="3" RadiusY="3">
                <Rectangle.RenderTransform>
                  <RotateTransform Angle="-20"/>
                </Rectangle.RenderTransform>
              </Rectangle>

              <Rectangle Width="25" Height="25" 
                        Canvas.Right="200" Canvas.Bottom="120"
                        Fill="White" Opacity="0.1"
                        RadiusX="3" RadiusY="3">
                <Rectangle.RenderTransform>
                  <RotateTransform Angle="45"/>
                </Rectangle.RenderTransform>
              </Rectangle>
            </Canvas>

            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="12">
              <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                <Image Source="{Binding Source='avares://ObsMCLauncher.Desktop/Assets/logo.png', Converter={StaticResource BitmapConverter}}" 
                       Width="60" Height="60"
                       Margin="0,0,16,0"/>
                <TextBlock Text="Obs MC Launcher" 
                           FontSize="38" FontWeight="Bold"
                           Foreground="White" VerticalAlignment="Center"/>
              </StackPanel>

              <TextBlock Text="è®©æ‚¨çš„ Minecraft ä¹‹æ—…æ›´åŠ è½»æ¾æ„‰å¿«" 
                         FontSize="16" Foreground="{DynamicResource TextSecondaryBrush}"
                         HorizontalAlignment="Center"/>

              <TextBlock Text="ðŸŽ® å¼€å§‹æ‚¨çš„å†’é™©å§" 
                         FontSize="14" Foreground="{DynamicResource TextTertiaryBrush}"
                         HorizontalAlignment="Center"/>
            </StackPanel>
          </Panel>
        </Border>

        <!-- 2. ä¸»é¡µå¡ç‰‡åŒºåŸŸ -->
        <Grid Grid.Row="1" Margin="0,0,0,16" RowDefinitions="*,Auto">
          <ItemsControl ItemsSource="{Binding HomeCards}">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <WrapPanel Orientation="Horizontal" HorizontalAlignment="Stretch"/>
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Classes="home-card"
                        Background="{DynamicResource SurfaceBrush}"
                        CornerRadius="12"
                        Padding="20"
                        Margin="0,0,12,12"
                        MinWidth="200"
                        MinHeight="100"
                        BorderThickness="1"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BoxShadow="0 2 10 0 #1A000000"
                        Cursor="{Binding CommandId, Converter={x:Static converters:NullToCursorConverter.Instance}}"
                        PointerPressed="Card_PointerPressed">
                  <StackPanel Spacing="8">
                    <TextBlock Text="{Binding Icon}" FontSize="24" Foreground="{DynamicResource TextBrush}"/>
                    <TextBlock Text="{Binding Title}" FontSize="15" FontWeight="SemiBold" TextWrapping="Wrap" Foreground="{DynamicResource TextBrush}"/>
                    <TextBlock Text="{Binding Description}" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}" TextWrapping="Wrap" MaxLines="2"/>
                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <!-- åˆ†é¡µæŽ§ä»¶ -->
          <StackPanel Grid.Row="1" 
                      Orientation="Horizontal" 
                      HorizontalAlignment="Center" 
                      Margin="0,4,0,0"
                      Spacing="8">
            <Button Content="ä¸Šä¸€é¡µ" Classes="secondary" Height="34" Padding="14,0"/>
            <TextBlock Text="1 / 1" VerticalAlignment="Center" FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}"/>
            <Button Content="ä¸‹ä¸€é¡µ" Classes="secondary" Height="34" Padding="14,0"/>
          </StackPanel>
        </Grid>

        <!-- 3. å¿«é€Ÿå¯åŠ¨åŒºåŸŸ -->
        <Border Grid.Row="2"
                Background="{DynamicResource SurfaceBrush}"
                CornerRadius="10"
                Padding="20"
                Margin="0,16,0,0">
          <Grid RowDefinitions="Auto,Auto">
            
            <Grid Grid.Row="0" ColumnDefinitions="*,12,*,12,Auto">
              <!-- è´¦å·é€‰æ‹© - æœ‰è´¦å·æ—¶æ˜¾ç¤º -->
              <ComboBox Grid.Column="0"
                        PlaceholderText="é€‰æ‹©æ¸¸æˆè´¦å·"
                        HorizontalAlignment="Stretch"
                        Height="40"
                        ItemsSource="{Binding Accounts}"
                        SelectedItem="{Binding SelectedAccount}"
                        IsVisible="{Binding HasAccounts}">
                <ComboBox.ItemTemplate>
                  <DataTemplate>
                    <Grid ColumnDefinitions="Auto,*,Auto" Height="32">
                      <!-- å¤´åƒåŒºåŸŸ - æœ‰çš®è‚¤å¤´åƒæ—¶æ˜¾ç¤º -->
                      <Border Grid.Column="0" Width="24" Height="24" CornerRadius="4" ClipToBounds="True" 
                              Background="{DynamicResource SurfaceBrush}" VerticalAlignment="Center"
                              IsVisible="{Binding Avatar, Converter={x:Static converters:NullToBoolConverter.Instance}}">
                        <Image Source="{Binding Avatar}" Stretch="Uniform" />
                      </Border>
                      <!-- é»˜è®¤å›¾æ ‡åŒºåŸŸ - æ— çš®è‚¤å¤´åƒæ—¶æ˜¾ç¤ºè´¦å·ç±»åž‹å›¾æ ‡ (ä»…åœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­æ˜¾ç¤º) -->
                      <TextBlock Grid.Column="0" Width="24" Height="24"
                                 Text="{Binding Type, Converter={x:Static converters:EnumToChineseTextConverter.Instance}, ConverterParameter=Icon}"
                                 FontSize="16" HorizontalAlignment="Center" VerticalAlignment="Center"
                                 IsVisible="{Binding Avatar, Converter={x:Static converters:NullToBoolConverter.Instance}, ConverterParameter=Invert}"/>
                      <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="8,0,0,0">
                        <TextBlock Text="{Binding Username}" FontSize="13" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                        <TextBlock Text="{Binding Type, Converter={x:Static converters:EnumToChineseTextConverter.Instance}}" 
                                   FontSize="10" Opacity="0.6" />
                      </StackPanel>
                    </Grid>
                  </DataTemplate>
                </ComboBox.ItemTemplate>
                <!-- ä¿®å¤ï¼šæœªé€‰æ‹©è´¦å·æ—¶ä¸æ˜¾ç¤ºå¤´åƒå›¾æ ‡ -->
                <ComboBox.SelectionBoxItemTemplate>
                  <DataTemplate>
                    <Grid ColumnDefinitions="Auto,*" Height="32">
                      <Border Grid.Column="0" Width="24" Height="24" CornerRadius="4" ClipToBounds="True" 
                              Background="{DynamicResource SurfaceBrush}" VerticalAlignment="Center"
                              IsVisible="{Binding Avatar, Converter={x:Static converters:NullToBoolConverter.Instance}}">
                        <Image Source="{Binding Avatar}" Stretch="Uniform" />
                      </Border>
                      <TextBlock Grid.Column="1" Text="{Binding Username}" VerticalAlignment="Center" Margin="8,0,0,0" FontSize="13" FontWeight="SemiBold"/>
                    </Grid>
                  </DataTemplate>
                </ComboBox.SelectionBoxItemTemplate>
              </ComboBox>

              <!-- æ— è´¦å·æ—¶æ˜¾ç¤ºæç¤º -->
              <Border Grid.Column="0"
                      Background="{DynamicResource SurfaceElevatedBrush}"
                      CornerRadius="6"
                      Height="40"
                      HorizontalAlignment="Stretch"
                      IsVisible="{Binding !HasAccounts}">
                <TextBlock Text="è¯·æ·»åŠ è´¦å·"
                           FontSize="14"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Center"/>
              </Border>

              <!-- ç‰ˆæœ¬é€‰æ‹© -->
              <Grid Grid.Column="2" ColumnDefinitions="*,Auto">
                <ComboBox Grid.Column="0"
                          PlaceholderText="é€‰æ‹©æ¸¸æˆç‰ˆæœ¬"
                          HorizontalAlignment="Stretch"
                          Height="40"
                          ItemsSource="{Binding InstalledVersions}"
                          SelectedItem="{Binding SelectedInstalledVersion}">
                  <ComboBox.ItemTemplate>
                    <DataTemplate>
                      <TextBlock Text="{Binding Id}" FontSize="13" TextTrimming="CharacterEllipsis"/>
                    </DataTemplate>
                  </ComboBox.ItemTemplate>
                </ComboBox>
                
                <Button Grid.Column="1"
                        Command="{Binding OpenVersionDetailCommand}"
                        Width="40" Height="40" Margin="8,0,0,0"
                        ToolTip.Tip="ç®¡ç†å½“å‰ç‰ˆæœ¬">
                  <TextBlock Text="âš™" FontSize="18" Foreground="{DynamicResource PrimaryBrush}" HorizontalAlignment="Center"/>
                </Button>
              </Grid>

              <!-- å¯åŠ¨æŒ‰é’® -->
              <Button Grid.Column="4"
                      Content="å¯åŠ¨æ¸¸æˆ"
                      Height="40" Width="130"
                      FontSize="14"
                      Classes="accent"
                      Background="{DynamicResource PrimaryBrush}"
                      Command="{Binding LaunchCommand}">
              </Button>
            </Grid>
            
            <!-- å¯åŠ¨é€‰é¡¹ -->
            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,8,0,0" HorizontalAlignment="Right">
              <CheckBox Content="å¯åŠ¨æ—¶æ˜¾ç¤ºæ¸¸æˆæ—¥å¿—"
                        IsChecked="{Binding ShowGameLog}"
                        FontSize="13"/>
            </StackPanel>
          </Grid>
        </Border>

      </Grid>
    </ScrollViewer>

    <!-- å®žä¾‹ç®¡ç†è¦†ç›–å±‚ -->
    <views:InstanceView DataContext="{Binding InstanceViewModel}"/>
  </Grid>
</UserControl>
