<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:ObsMCLauncher.Desktop.ViewModels"
             xmlns:views="using:ObsMCLauncher.Desktop.Views"
             xmlns:mc="using:ObsMCLauncher.Core.Services.Minecraft"
             xmlns:converters="using:ObsMCLauncher.Desktop.Converters"
             x:Class="ObsMCLauncher.Desktop.Views.VersionDownloadView"
             x:DataType="vm:VersionDownloadViewModel">

  <UserControl.Resources>
    <converters:BitmapAssetValueConverter x:Key="BitmapConverter"/>
  </UserControl.Resources>

  <Grid>
    <!-- ç‰ˆæœ¬åˆ—è¡¨å†…å®¹ -->
    <Grid x:Name="VersionListGrid" Margin="24" RowDefinitions="Auto,*">

      <!-- æ ‡é¢˜åŒºåŸŸ -->
      <StackPanel Grid.Row="0">
        <TextBlock Text="ç‰ˆæœ¬ç®¡ç†"
                   FontSize="28"
                   FontWeight="Bold"
                   Margin="0,0,0,8"/>
        <TextBlock Text="ç®¡ç†å·²å®‰è£…çš„ç‰ˆæœ¬æˆ–ä¸‹è½½æ–°ç‰ˆæœ¬"
                   FontSize="14"
                   Foreground="{DynamicResource TextSecondaryBrush}"
                   Margin="0,0,0,16"/>
      </StackPanel>

      <!-- Tab æŽ§ä»¶ -->
      <TabControl Grid.Row="1">

        <!-- å·²å®‰è£…ç‰ˆæœ¬ Tab -->
        <TabItem Header="å·²å®‰è£…ç‰ˆæœ¬">
          <Grid Margin="0,20,0,0" RowDefinitions="Auto,*">

            <!-- å·¥å…·æ  -->
            <Border Grid.Row="0"
                    Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="8"
                    Padding="15,10"
                    Margin="0,0,0,15"
                    BorderThickness="1"
                    BorderBrush="{DynamicResource BorderBrush}">
              <Grid ColumnDefinitions="*,Auto">

                <TextBlock Grid.Column="0"
                           VerticalAlignment="Center"
                           FontSize="13"
                           Foreground="{DynamicResource TextSecondaryBrush}">
                  <Run Text="å…± "/>
                  <Run Text="{Binding InstalledVersionsCount}" FontWeight="SemiBold"/>
                  <Run Text=" ä¸ªå·²å®‰è£…ç‰ˆæœ¬"/>
                </TextBlock>

                <Button Grid.Column="1"
                        Command="{Binding RefreshInstalledCommand}"
                        Height="30"
                        FontSize="12"
                        Padding="12,0">
                  <StackPanel Orientation="Horizontal" Spacing="6">
                    <TextBlock Text="â†»" VerticalAlignment="Center"/>
                    <TextBlock Text="åˆ·æ–°" VerticalAlignment="Center"/>
                  </StackPanel>
                </Button>

              </Grid>
            </Border>

            <!-- å·²å®‰è£…ç‰ˆæœ¬åˆ—è¡¨ -->
            <Border Grid.Row="1"
                    Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="10"
                    BorderThickness="1"
                    BorderBrush="{DynamicResource BorderBrush}">
              <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding InstalledVersions}" Margin="10">
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Border Background="{DynamicResource SurfaceElevatedBrush}"
                              CornerRadius="6"
                              Padding="15,12"
                              Margin="10,5">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                          <Image Grid.Column="0" Width="28" Height="28" Margin="0,0,12,0"
                                 Source="{Binding LoaderIconPath, Converter={StaticResource BitmapConverter}}"/>
                          
                          <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                              <TextBlock Text="{Binding Id}" FontSize="14" FontWeight="SemiBold"/>
                              <Border Background="{DynamicResource PrimaryBrush}"
                                      CornerRadius="3"
                                      Padding="6,1"
                                      IsVisible="{Binding IsSelected}">
                                <TextBlock Text="å½“å‰ç‰ˆæœ¬" FontSize="10" FontWeight="SemiBold" Foreground="White"/>
                              </Border>
                            </StackPanel>
                            <TextBlock Text="{Binding DetailText}" FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,3,0,0"/>
                          </StackPanel>

                          <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                            <Button Content="é€‰æ‹©"
                                    Height="28"
                                    FontSize="12"
                                    Padding="12,0"
                                    Command="{Binding $parent[UserControl].((vm:VersionDownloadViewModel)DataContext).SelectInstalledCommand}"
                                    CommandParameter="{Binding}"
                                    IsVisible="{Binding !IsSelected}"/>

                            <Button Content="â–¶"
                                    Width="28" Height="28" Padding="0"
                                    ToolTip.Tip="å¿«é€Ÿå¯åŠ¨"
                                    Command="{Binding $parent[UserControl].((vm:VersionDownloadViewModel)DataContext).QuickLaunchCommand}"
                                    CommandParameter="{Binding}"/>

                            <Button Content="âš™"
                                    Width="28" Height="28" Padding="0"
                                    ToolTip.Tip="ç®¡ç†å®žä¾‹"
                                    Command="{Binding $parent[UserControl].((vm:VersionDownloadViewModel)DataContext).OpenInstanceCommand}"
                                    CommandParameter="{Binding}"/>

                            <Button Content="ðŸ—‘"
                                    Width="28" Height="28" Padding="0"
                                    ToolTip.Tip="åˆ é™¤ç‰ˆæœ¬"
                                    Classes="danger"
                                    Command="{Binding $parent[UserControl].((vm:VersionDownloadViewModel)DataContext).DeleteInstalledCommand}"
                                    CommandParameter="{Binding}"/>
                          </StackPanel>
                        </Grid>
                      </Border>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </ScrollViewer>
            </Border>

          </Grid>
        </TabItem>

        <!-- ä¸‹è½½æ–°ç‰ˆæœ¬ Tab -->
        <TabItem Header="ä¸‹è½½æ–°ç‰ˆæœ¬">
          <Grid Margin="0,20,0,0" RowDefinitions="Auto,*">

            <!-- ç­›é€‰å’Œæœç´¢åŒºåŸŸ -->
            <Border Grid.Row="0"
                    Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="8"
                    Padding="15,10"
                    Margin="0,0,0,15"
                    BorderThickness="1"
                    BorderBrush="{DynamicResource BorderBrush}">
              <Grid ColumnDefinitions="*,Auto,Auto">

                <TextBox Grid.Column="0"
                         Watermark="æœç´¢ç‰ˆæœ¬å·..."
                         FontSize="13"
                         Margin="0,0,12,0"
                         Text="{Binding SearchText}"/>

                <ComboBox Grid.Column="1"
                          Width="120"
                          FontSize="13"
                          Margin="0,0,10,0"
                          SelectedIndex="{Binding SelectedTypeIndex}">
                  <ComboBoxItem Content="å…¨éƒ¨ç‰ˆæœ¬"/>
                  <ComboBoxItem Content="æ­£å¼ç‰ˆ"/>
                  <ComboBoxItem Content="å¿«ç…§ç‰ˆ"/>
                  <ComboBoxItem Content="è¿œå¤ç‰ˆ"/>
                </ComboBox>

                <Button Grid.Column="2"
                        Width="32" Height="32" Padding="0"
                        ToolTip.Tip="åˆ·æ–°ç‰ˆæœ¬åˆ—è¡¨"
                        Command="{Binding RefreshOnlineCommand}">
                  <TextBlock Text="â†»" FontSize="18" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                </Button>

              </Grid>
            </Border>

            <!-- ç‰ˆæœ¬åˆ—è¡¨ / éª¨æž¶å± -->
            <Border Grid.Row="1"
                    Background="{DynamicResource SurfaceBrush}"
                    CornerRadius="10"
                    BorderThickness="1"
                    BorderBrush="{DynamicResource BorderBrush}">
              <Grid>

                <!-- ç‰ˆæœ¬åˆ—è¡¨ -->
                <ScrollViewer VerticalScrollBarVisibility="Auto" IsVisible="{Binding !IsLoading}">
                  <ItemsControl ItemsSource="{Binding FilteredVersions}" Margin="0,10">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate x:DataType="mc:MinecraftVersion">
                        <Button Command="{Binding $parent[UserControl].((vm:VersionDownloadViewModel)DataContext).OpenDetailCommand}"
                                CommandParameter="{Binding}"
                                HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Stretch"
                                Padding="0"
                                Margin="20,0,20,12"
                                Background="Transparent"
                                BorderThickness="0">
                          <Border Background="{DynamicResource SurfaceElevatedBrush}"
                                  CornerRadius="6"
                                  Padding="12,10">
                            <Grid ColumnDefinitions="Auto,*,Auto">

                              <Image Width="28" Height="28" Margin="0,0,12,0"
                                     Source="{Binding IconPath, Converter={StaticResource BitmapConverter}}"/>

                              <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                <TextBlock FontSize="15" FontWeight="SemiBold">
                                  <Run Text="Minecraft "/>
                                  <Run Text="{Binding Id}"/>
                                  <Run Text=" [" FontSize="11"/>
                                  <Run Text="{Binding Type}" FontSize="11"/>
                                  <Run Text="]" FontSize="11"/>
                                </TextBlock>
                                <TextBlock Text="{Binding ReleaseTime, StringFormat='å‘å¸ƒæ—¶é—´: {0:yyyy-MM-dd HH:mm}'}"
                                           FontSize="11"
                                           Margin="0,3,0,0"
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                              </StackPanel>

                              <TextBlock Grid.Column="2" Text="â€º" FontSize="20"
                                         VerticalAlignment="Center"
                                         Foreground="{DynamicResource TextSecondaryBrush}"/>

                            </Grid>
                          </Border>
                        </Button>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </ScrollViewer>

                <!-- éª¨æž¶å±åŠ è½½æ•ˆæžœ (1:1 å¯¹é½é¡¹å¸ƒå±€) -->
                <StackPanel IsVisible="{Binding IsLoading}" Margin="20,10">
                  <Border Background="{DynamicResource SurfaceElevatedBrush}" CornerRadius="6" Padding="12,10" Margin="0,0,0,12" Opacity="0.6">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                      <Border Grid.Column="0" Width="28" Height="28" CornerRadius="14" Background="{DynamicResource SurfaceHoverBrush}" Margin="0,0,12,0"/>
                      <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="8">
                        <Border Width="150" Height="14" HorizontalAlignment="Left" Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="2"/>
                        <Border Width="100" Height="10" HorizontalAlignment="Left" Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="2"/>
                      </StackPanel>
                    </Grid>
                  </Border>
                  <Border Background="{DynamicResource SurfaceElevatedBrush}" CornerRadius="6" Padding="12,10" Margin="0,0,0,12" Opacity="0.4">
                    <Grid ColumnDefinitions="Auto,*,Auto">
                      <Border Grid.Column="0" Width="28" Height="28" CornerRadius="14" Background="{DynamicResource SurfaceHoverBrush}" Margin="0,0,12,0"/>
                      <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="8">
                        <Border Width="150" Height="14" HorizontalAlignment="Left" Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="2"/>
                        <Border Width="100" Height="10" HorizontalAlignment="Left" Background="{DynamicResource SurfaceHoverBrush}" CornerRadius="2"/>
                      </StackPanel>
                    </Grid>
                  </Border>
                </StackPanel>

              </Grid>
            </Border>

          </Grid>
        </TabItem>

      </TabControl>

    </Grid>

    <!-- ç‰ˆæœ¬è¯¦æƒ…å†…å®¹ï¼ˆå åŠ æ˜¾ç¤ºï¼‰ -->
    <Border IsVisible="{Binding IsDetailOpen}"
            Background="#80000000">
      <ContentControl Content="{Binding DetailPage}"/>
    </Border>

    <!-- å®žä¾‹ç®¡ç†è¦†ç›–å±‚ -->
    <views:InstanceView DataContext="{Binding InstanceViewModel}"/>

  </Grid>

</UserControl>
